<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>관리자 페이지</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <header class="header">
        <h1>관리자 페이지 <span class="badge">ADMIN</span></h1>
    </header>
    <main class="container">
        <label for="team-selector">팀 선택:</label>
        <select id="team-selector">
            <option value="all">전체</option>
        </select>
        <section id="team-view" class="team-view"></section>
        <section id="cards-list" class="cards-list"></section>
    </main>
    <script>
        async function fetchCards() {
            try {
                const res = await fetch('/api/cards');
                if (!res.ok) throw new Error('카드를 불러오는 데 실패했습니다.');
                return await res.json();
            } catch (e) {
                alert(e.message);
                return [];
            }
        }

        function createCardElement(card) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'admin-card-item';

            const nameLabel = document.createElement('label');
            nameLabel.textContent = '이름';
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.value = card.name || '';
            nameInput.className = 'card-input';

            const teamLabel = document.createElement('label');
            teamLabel.textContent = '팀';
            const teamInput = document.createElement('input');
            teamInput.type = 'text';
            teamInput.value = card.team || '';
            teamInput.className = 'card-input';

            const iconLabel = document.createElement('label');
            iconLabel.textContent = '아이콘';
            const iconInput = document.createElement('input');
            iconInput.type = 'text';
            iconInput.value = card.icon || '';
            iconInput.className = 'card-input';

            const gradeLabel = document.createElement('label');
            gradeLabel.textContent = '직책';
            const gradeInput = document.createElement('input');
            gradeInput.type = 'text';
            gradeInput.value = card.grade || '';
            gradeInput.className = 'card-input';

            const btnGroup = document.createElement('div');
            btnGroup.className = 'btn-group';

            const saveBtn = document.createElement('button');
            saveBtn.textContent = '저장';
            saveBtn.className = 'btn save-btn';

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '삭제';
            deleteBtn.className = 'btn delete-btn';

            btnGroup.appendChild(saveBtn);
            btnGroup.appendChild(deleteBtn);

            cardDiv.appendChild(nameLabel);
            cardDiv.appendChild(nameInput);
            cardDiv.appendChild(teamLabel);
            cardDiv.appendChild(teamInput);
            cardDiv.appendChild(iconLabel);
            cardDiv.appendChild(iconInput);
            cardDiv.appendChild(gradeLabel);
            cardDiv.appendChild(gradeInput);
            cardDiv.appendChild(btnGroup);

            saveBtn.addEventListener('click', async () => {
                const updatedCard = {
                    name: nameInput.value.trim(),
                    team: teamInput.value.trim(),
                    icon: iconInput.value.trim(),
                    grade: gradeInput.value.trim(),
                    win: card.win || 0,
                    losses: card.losses || 0,
                };
                if (!updatedCard.name || !updatedCard.team) {
                    alert('이름과 팀을 입력해주세요.');
                    return;
                }
                try {
                    const res = await fetch('/api/cards/' + card.id, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(updatedCard),
                    });
                    if (!res.ok) throw new Error('카드 수정에 실패했습니다.');
                    alert('카드가 수정되었습니다.');
                } catch (e) {
                    alert(e.message);
                }
            });

            deleteBtn.addEventListener('click', async () => {
                if (!confirm('정말로 이 카드를 삭제하시겠습니까?')) return;
                try {
                    const res = await fetch('/api/cards/' + card.id, {
                        method: 'DELETE',
                    });
                    if (!res.ok) throw new Error('카드 삭제에 실패했습니다.');
                    alert('카드가 삭제되었습니다.');
                    cardDiv.remove();
                } catch (e) {
                    alert(e.message);
                }
            });

            return cardDiv;
        }

        function renderTeamOptions(cards) {
            const teamSelector = document.getElementById('team-selector');
            const teams = new Set(cards.map(card => card.team).filter(Boolean));
            // Clear existing options except "all"
            teamSelector.innerHTML = '<option value="all">전체</option>';
            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                teamSelector.appendChild(option);
            });
        }

        function createTeamViewCard(card) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'team-card-item';

            const iconSpan = document.createElement('span');
            iconSpan.className = 'card-icon';
            iconSpan.textContent = card.icon || '';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'card-name';
            nameSpan.textContent = card.name || '';

            const gradeSpan = document.createElement('span');
            gradeSpan.className = 'card-grade';
            gradeSpan.textContent = card.grade || '';

            cardDiv.appendChild(iconSpan);
            cardDiv.appendChild(nameSpan);
            cardDiv.appendChild(gradeSpan);

            return cardDiv;
        }

        async function renderCards() {
            const cardsList = document.getElementById('cards-list');
            cardsList.innerHTML = '';
            const cards = await fetchCards();
            if (cards.length === 0) {
                cardsList.textContent = '등록된 카드가 없습니다.';
                return;
            }
            renderTeamOptions(cards);
            cards.forEach(card => {
                cardsList.appendChild(createCardElement(card));
            });
            renderTeamView(cards); // Show all cards initially
        }

        function renderTeamView(cards) {
            const teamView = document.getElementById('team-view');
            const teamSelector = document.getElementById('team-selector');
            const selectedTeam = teamSelector.value;
            teamView.innerHTML = '';

            const filteredCards = selectedTeam === 'all' ? cards : cards.filter(card => card.team === selectedTeam);
            if (filteredCards.length === 0) {
                teamView.textContent = '선택한 팀의 카드가 없습니다.';
                return;
            }
            filteredCards.forEach(card => {
                teamView.appendChild(createTeamViewCard(card));
            });
        }

        document.getElementById('team-selector').addEventListener('change', async () => {
            const cards = await fetchCards();
            renderTeamView(cards);
        });

        renderCards();
    </script>
</body>
</html>
