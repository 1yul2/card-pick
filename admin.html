<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>관리자 페이지</title>
    <link rel="stylesheet" href="/static/style.css" />
    <style>
      body {
        font-family: 'Apple SD Gothic Neo', sans-serif;
        margin: 0;
        background: #111827;
        color: #f9fafb;
      }
      .header {
        padding: 16px;
        background: #1f2937;
        text-align: center;
      }
      .header h1 {
        margin: 0;
        font-size: 20px;
      }
      .badge {
        font-size: 12px;
        background: #2563eb;
        padding: 3px 8px;
        border-radius: 6px;
        margin-left: 8px;
      }
      .container {
        padding: 16px;
        max-width: 600px;
        margin: auto;
      }
      select {
        width: 100%;
        padding: 8px;
        margin-bottom: 16px;
        border-radius: 6px;
        border: 1px solid #374151;
        background: #1f2937;
        color: #f9fafb;
      }
      .team-view, .cards-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .team-card-item {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #1f2937;
        padding: 12px;
        border-radius: 8px;
      }
      .card-input {
        width: 100%;
        padding: 8px;
        border: 1px solid #374151;
        border-radius: 6px;
        background: #111827;
        color: #f9fafb;
        box-sizing: border-box;
      }
      .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 8px;
      }
      .btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
      }
      .save-btn {
        background: #2563eb;
        color: white;
      }
      .delete-btn {
        background: #dc2626;
        color: white;
      }
      .admin-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
      }
      .admin-table th, .admin-table td {
        border: 1px solid #374151;
        padding: 8px;
        text-align: center;
      }
      .admin-table th {
        background: #1f2937;
      }
    </style>
</head>
<body>
    <header class="header">
        <h1>관리자 페이지 <span class="badge">ADMIN</span></h1>
    </header>
    <main class="container">
        <label for="team-selector">팀 선택:</label>
        <select id="team-selector">
            <option value="all">전체</option>
        </select>
        <section id="team-view" class="team-view"></section>
        <section id="cards-list" class="cards-list"></section>
    </main>
    <script>
        async function fetchCards() {
            try {
                const res = await fetch('/api/cards');
                if (!res.ok) throw new Error('카드를 불러오는 데 실패했습니다.');
                return await res.json();
            } catch (e) {
                alert(e.message);
                return [];
            }
        }

        function createCardElement(card) {
            const tr = document.createElement('tr');

            // ID cell (not editable)
            const idTd = document.createElement('td');
            idTd.textContent = card.id || '';
            tr.appendChild(idTd);

            // 이름 input
            const nameTd = document.createElement('td');
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.value = card.name || '';
            nameInput.className = 'card-input';
            nameTd.appendChild(nameInput);
            tr.appendChild(nameTd);

            // 팀 input
            const teamTd = document.createElement('td');
            const teamInput = document.createElement('input');
            teamInput.type = 'text';
            teamInput.value = card.team || '';
            teamInput.className = 'card-input';
            teamTd.appendChild(teamInput);
            tr.appendChild(teamTd);

            // 아이콘 input
            const iconTd = document.createElement('td');
            const iconInput = document.createElement('input');
            iconInput.type = 'text';
            iconInput.value = card.icon || '';
            iconInput.className = 'card-input';
            iconTd.appendChild(iconInput);
            tr.appendChild(iconTd);

            // 직책 input
            const gradeTd = document.createElement('td');
            const gradeInput = document.createElement('input');
            gradeInput.type = 'text';
            gradeInput.value = card.grade || '';
            gradeInput.className = 'card-input';
            gradeTd.appendChild(gradeInput);
            tr.appendChild(gradeTd);

            // Wins input
            const winTd = document.createElement('td');
            const winInput = document.createElement('input');
            winInput.type = 'number';
            winInput.min = '0';
            winInput.value = card.win || 0;
            winInput.className = 'card-input';
            winTd.appendChild(winInput);
            tr.appendChild(winTd);

            // Losses input
            const lossesTd = document.createElement('td');
            const lossesInput = document.createElement('input');
            lossesInput.type = 'number';
            lossesInput.min = '0';
            lossesInput.value = card.losses || 0;
            lossesInput.className = 'card-input';
            lossesTd.appendChild(lossesInput);
            tr.appendChild(lossesTd);

            // 작업 (actions) cell with buttons
            const actionTd = document.createElement('td');

            const saveBtn = document.createElement('button');
            saveBtn.textContent = '저장';
            saveBtn.className = 'btn save-btn';

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '삭제';
            deleteBtn.className = 'btn delete-btn';

            actionTd.appendChild(saveBtn);
            actionTd.appendChild(deleteBtn);
            tr.appendChild(actionTd);

            saveBtn.addEventListener('click', async () => {
                const updatedCard = {
                    name: nameInput.value.trim(),
                    team: teamInput.value.trim(),
                    icon: iconInput.value.trim(),
                    grade: gradeInput.value.trim(),
                    win: Number(winInput.value) || 0,
                    losses: Number(lossesInput.value) || 0,
                };
                if (!updatedCard.name || !updatedCard.team) {
                    alert('이름과 팀을 입력해주세요.');
                    return;
                }
                try {
                    const res = await fetch('/api/cards/' + card.id, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(updatedCard),
                    });
                    if (!res.ok) throw new Error('카드 수정에 실패했습니다.');
                    alert('카드가 수정되었습니다.');
                } catch (e) {
                    alert(e.message);
                }
            });

            deleteBtn.addEventListener('click', async () => {
                if (!confirm('정말로 이 카드를 삭제하시겠습니까?')) return;
                try {
                    const res = await fetch('/api/cards/' + card.id, {
                        method: 'DELETE',
                    });
                    if (!res.ok) throw new Error('카드 삭제에 실패했습니다.');
                    alert('카드가 삭제되었습니다.');
                    tr.remove();
                } catch (e) {
                    alert(e.message);
                }
            });

            return tr;
        }

        function renderTeamOptions(cards) {
            const teamSelector = document.getElementById('team-selector');
            const teams = new Set(cards.map(card => card.team).filter(Boolean));
            // Clear existing options except "all"
            teamSelector.innerHTML = '<option value="all">전체</option>';
            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                teamSelector.appendChild(option);
            });
        }

        function createTeamViewCard(card) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'team-card-item';

            const iconSpan = document.createElement('span');
            iconSpan.className = 'card-icon';
            iconSpan.textContent = card.icon || '';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'card-name';
            nameSpan.textContent = card.name || '';

            const gradeSpan = document.createElement('span');
            gradeSpan.className = 'card-grade';
            gradeSpan.textContent = card.grade || '';

            cardDiv.appendChild(iconSpan);
            cardDiv.appendChild(nameSpan);
            cardDiv.appendChild(gradeSpan);

            return cardDiv;
        }

        async function renderCards() {
            const cardsList = document.getElementById('cards-list');
            cardsList.innerHTML = '';
            const cards = await fetchCards();
            if (cards.length === 0) {
                cardsList.textContent = '등록된 카드가 없습니다.';
                return;
            }
            renderTeamOptions(cards);

            const table = document.createElement('table');
            table.className = 'admin-table';

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            ['ID', '이름', '팀', '아이콘', '직책', 'Wins', 'Losses', '작업'].forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            cards.forEach(card => {
                tbody.appendChild(createCardElement(card));
            });
            table.appendChild(tbody);

            cardsList.appendChild(table);

            renderTeamView(cards); // Show all cards initially
        }

        function renderTeamView(cards) {
            const teamView = document.getElementById('team-view');
            const teamSelector = document.getElementById('team-selector');
            const selectedTeam = teamSelector.value;
            teamView.innerHTML = '';

            const filteredCards = selectedTeam === 'all' ? cards : cards.filter(card => card.team === selectedTeam);
            if (filteredCards.length === 0) {
                teamView.textContent = '선택한 팀의 카드가 없습니다.';
                return;
            }
            filteredCards.forEach(card => {
                teamView.appendChild(createTeamViewCard(card));
            });
        }

        document.getElementById('team-selector').addEventListener('change', async () => {
            const cards = await fetchCards();
            renderTeamView(cards);
        });

        renderCards();
    </script>
</body>
<script src="/static/script.js"></script>
</html>
